<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Checkout | Stripe Checkout Playground</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f6f9fc;
      min-height: 100vh;
    }

    /* Branding config panel (floating) */
    .config-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: #32325d;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .config-toggle:hover { background: #424270; }
    .config-panel {
      display: none;
      position: fixed;
      top: 56px;
      right: 16px;
      z-index: 999;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      padding: 20px;
      width: 320px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    .config-panel.show { display: block; }
    .config-panel h3 {
      font-size: 14px;
      color: #32325d;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e6ebf1;
    }
    .cfg-group {
      margin-bottom: 12px;
    }
    .cfg-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #525f7f;
      margin-bottom: 4px;
    }
    .cfg-group input[type="text"],
    .cfg-group input[type="number"],
    .cfg-group select,
    .cfg-group textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e6ebf1;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }
    .cfg-group textarea {
      height: 60px;
      resize: vertical;
    }
    .cfg-color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .cfg-color-row input[type="color"] {
      width: 36px;
      height: 32px;
      border: 1px solid #e6ebf1;
      border-radius: 4px;
      padding: 2px;
      cursor: pointer;
    }
    .cfg-color-row input[type="text"] {
      flex: 1;
      font-family: monospace;
    }
    .cfg-btn {
      width: 100%;
      padding: 10px;
      background: #635bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .cfg-btn:hover { background: #5469d4; }
    .cfg-btn.secondary {
      background: #e6ebf1;
      color: #32325d;
    }
    .cfg-btn.secondary:hover { background: #d4dbe3; }
    .cfg-preset-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
      margin-bottom: 12px;
    }
    .cfg-preset {
      padding: 6px;
      border: 2px solid #e6ebf1;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      color: #525f7f;
    }
    .cfg-preset:hover { border-color: #635bff; }

    /* School branded header */
    .school-header {
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .school-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: 700;
    }
    .school-header-text {
      color: white;
    }
    .school-header-text h1 {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.2;
    }
    .school-header-text p {
      font-size: 11px;
      opacity: 0.8;
    }

    /* Main checkout layout */
    .checkout-page {
      max-width: 720px;
      margin: 0 auto;
      padding: 32px 20px;
      transition: max-width 0.3s ease;
    }
    .checkout-page.layout-wide {
      max-width: 1100px;
    }

    /* Left: Checkout form area */
    .checkout-main {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .checkout-main-header {
      padding: 24px 24px 0;
    }
    .checkout-main-header h2 {
      font-size: 20px;
      color: #32325d;
      margin-bottom: 4px;
    }
    .checkout-main-header p {
      font-size: 14px;
      color: #6b7c93;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    #checkout {
      min-height: 400px;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      color: #6b7c93;
      font-size: 14px;
    }
    .error {
      padding: 16px 24px;
      color: #cd3d64;
      background: #ffeef1;
      border-radius: 4px;
      margin: 20px;
    }

    /* Trust bar below checkout */
    .trust-bar {
      display: flex;
      gap: 24px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
      padding: 16px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .trust-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .trust-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
    .trust-item p {
      font-size: 12px;
      color: #6b7c93;
      line-height: 1.3;
    }
    .trust-item strong {
      color: #32325d;
    }

    /* School info card above checkout */
    .school-info-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 20px;
      text-align: center;
    }
    .school-info-card .product-badge {
      display: inline-block;
      font-size: 28px;
      margin-bottom: 8px;
    }
    .school-info-card h2 {
      font-size: 22px;
      color: #32325d;
      margin-bottom: 6px;
    }
    .school-info-card p {
      font-size: 14px;
      color: #6b7c93;
      line-height: 1.5;
      max-width: 500px;
      margin: 0 auto;
    }

    /* Back link */
    .back-bar {
      padding: 12px 32px;
      background: white;
      border-bottom: 1px solid #e6ebf1;
    }
    .back-bar a {
      color: #635bff;
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
    }
    .back-bar a:hover { text-decoration: underline; }

    @media (max-width: 600px) {
      .trust-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

  <!-- Floating config panel -->
  <button class="config-toggle" onclick="toggleConfig()">Branding Config</button>
  <div class="config-panel" id="configPanel">
    <h3>School Branding</h3>

    <label style="font-size:11px;color:#8898aa;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px;display:block;">Quick Presets</label>
    <div class="cfg-preset-row">
      <button class="cfg-preset" onclick="loadPreset('dark')">Dark Tech</button>
      <button class="cfg-preset" onclick="loadPreset('blue')">Blue Academy</button>
      <button class="cfg-preset" onclick="loadPreset('warm')">Warm School</button>
    </div>

    <label style="font-size:11px;color:#8898aa;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;margin:0 0 8px;display:block;">School Identity</label>
    <div class="cfg-group">
      <label>School Name</label>
      <input type="text" id="cfgSchoolName" value="Code Academy Pro">
    </div>
    <div class="cfg-group">
      <label>Logo Emoji / Initial</label>
      <input type="text" id="cfgLogo" value="CA" maxlength="3">
    </div>
    <div class="cfg-group">
      <label>Tagline</label>
      <input type="text" id="cfgTagline" value="Secure Checkout">
    </div>
    <div class="cfg-group">
      <label>Brand Color</label>
      <div class="cfg-color-row">
        <input type="color" id="cfgColor" value="#635bff" oninput="document.getElementById('cfgColorHex').value=this.value">
        <input type="text" id="cfgColorHex" value="#635bff" oninput="if(/^#[0-9a-f]{6}$/i.test(this.value))document.getElementById('cfgColor').value=this.value">
      </div>
    </div>
    <div class="cfg-group">
      <label>Product Emoji</label>
      <input type="text" id="cfgProductEmoji" value="&#127891;" maxlength="2">
    </div>

    <label style="font-size:11px;color:#8898aa;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;margin:16px 0 8px;display:block;">Checkout Session</label>
    <div class="cfg-group">
      <label>Product Name</label>
      <input type="text" id="cfgProductName" value="Full Access Membership">
    </div>
    <div class="cfg-group">
      <label>Price (cents)</label>
      <input type="number" id="cfgPrice" value="29900">
    </div>
    <div class="cfg-group">
      <label>Mode</label>
      <select id="cfgMode">
        <option value="payment">One-time Payment</option>
        <option value="subscription" selected>Subscription</option>
      </select>
    </div>
    <div class="cfg-group">
      <label>Checkout Header Text</label>
      <input type="text" id="cfgHeaderText" value="Complete your enrollment">
    </div>
    <div class="cfg-group">
      <label>Checkout Subtext</label>
      <textarea id="cfgSubtext">You're just one step away from unlimited learning. Your membership starts immediately after payment.</textarea>
    </div>
    <div class="cfg-group">
      <label>Trust Badge Text</label>
      <textarea id="cfgTrustText">30-day money-back guarantee. Cancel anytime. All transactions are secure and encrypted.</textarea>
    </div>

    <div class="cfg-group">
      <label>Checkout Layout</label>
      <select id="cfgLayout" onchange="toggleLayout(this.value)">
        <option value="stacked">Stacked (narrow — summary on top)</option>
        <option value="side-by-side">Side-by-side (wide — summary on left)</option>
      </select>
    </div>

    <button class="cfg-btn" onclick="applyBranding()">Apply & Load Checkout</button>
    <button class="cfg-btn secondary" onclick="applyBrandingOnly()">Apply Branding Only</button>
  </div>

  <!-- School header bar -->
  <div class="school-header" id="schoolHeader" style="background: #635bff;">
    <div class="school-logo" id="schoolLogo">CA</div>
    <div class="school-header-text">
      <h1 id="schoolName">Code Academy Pro</h1>
      <p id="schoolTagline">Secure Checkout</p>
    </div>
  </div>

  <div class="back-bar">
    <a href="/">&larr; Back to Playground Overview</a>
  </div>

  <!-- Checkout page -->
  <div class="checkout-page">
    <!-- School info + product context -->
    <div class="school-info-card">
      <div class="product-badge" id="productImage">&#127891;</div>
      <h2 id="checkoutHeader">Complete your enrollment</h2>
      <p id="checkoutSubtext">You're just one step away from unlimited learning. Your membership starts immediately after payment.</p>
    </div>

    <!-- Stripe Embedded Checkout (this is the only part Stripe renders) -->
    <div class="checkout-main">
      <div id="checkout">
        <div class="loading">Click "Branding Config" &rarr; "Apply & Load Checkout" to start</div>
      </div>
    </div>

    <!-- Trust bar (our custom code, not Stripe) -->
    <div class="trust-bar">
      <div class="trust-item">
        <svg class="trust-icon" viewBox="0 0 24 24" fill="#4caf50"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
        <p><strong>Secure payment</strong></p>
      </div>
      <div class="trust-item">
        <svg class="trust-icon" viewBox="0 0 24 24" fill="#2196f3"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        <p id="trustText"><strong>30-day money-back guarantee</strong></p>
      </div>
      <div class="trust-item">
        <svg class="trust-icon" viewBox="0 0 24 24" fill="#ff9800"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        <p><strong>Cancel anytime</strong></p>
      </div>
    </div>
  </div>

  <script>
    let stripe = null;
    let checkout = null;

    const stripeReady = (async function initStripe() {
      try {
        const res = await fetch('/config');
        const { publishableKey } = await res.json();
        stripe = Stripe(publishableKey);
      } catch (e) {
        console.error('Failed to init Stripe:', e);
      }
    })();

    function toggleConfig() {
      document.getElementById('configPanel').classList.toggle('show');
    }

    function toggleLayout(value) {
      const page = document.querySelector('.checkout-page');
      if (value === 'side-by-side') {
        page.classList.add('layout-wide');
      } else {
        page.classList.remove('layout-wide');
      }
    }

    function loadPreset(name) {
      const presets = {
        dark: {
          schoolName: 'DevPath Academy', logo: 'DP', tagline: 'Secure Checkout',
          color: '#2d2d2d', productName: 'Unlimited Access (Annual)',
          productEmoji: '\u{1F680}', price: 29900,
          mode: 'subscription', headerText: 'Get started',
          subtext: 'Join thousands of developers who have accelerated their careers.',
          trustText: '30-day money-back guarantee',
        },
        blue: {
          schoolName: 'DataSci Academy', logo: 'DS', tagline: 'Learn Data Science',
          color: '#1565c0', productName: 'Data Science Professional Track',
          productEmoji: '\u{1F4CA}', price: 49900,
          mode: 'payment', headerText: 'Enroll in your program',
          subtext: 'Start your data science journey today. Includes lifetime access to all materials.',
          trustText: '14-day refund policy',
        },
        warm: {
          schoolName: 'Creative Workshop', logo: '\u{1F3A8}', tagline: 'Checkout',
          color: '#d84315', productName: 'Design Fundamentals Masterclass',
          productEmoji: '\u{2728}', price: 7900,
          mode: 'payment', headerText: 'Almost there!',
          subtext: 'Complete your purchase to get instant access to all masterclass content.',
          trustText: '7-day money-back guarantee',
        },
      };
      const p = presets[name];
      document.getElementById('cfgSchoolName').value = p.schoolName;
      document.getElementById('cfgLogo').value = p.logo;
      document.getElementById('cfgTagline').value = p.tagline;
      document.getElementById('cfgColor').value = p.color;
      document.getElementById('cfgColorHex').value = p.color;
      document.getElementById('cfgProductName').value = p.productName;
      document.getElementById('cfgProductEmoji').value = p.productEmoji;
      document.getElementById('cfgPrice').value = p.price;
      document.getElementById('cfgMode').value = p.mode;
      document.getElementById('cfgHeaderText').value = p.headerText;
      document.getElementById('cfgSubtext').value = p.subtext;
      document.getElementById('cfgTrustText').value = p.trustText;
    }

    function applyBrandingOnly() {
      const color = document.getElementById('cfgColor').value;
      const schoolName = document.getElementById('cfgSchoolName').value;
      const logo = document.getElementById('cfgLogo').value;
      const tagline = document.getElementById('cfgTagline').value;
      const productEmoji = document.getElementById('cfgProductEmoji').value;
      const headerText = document.getElementById('cfgHeaderText').value;
      const subtext = document.getElementById('cfgSubtext').value;
      const trustText = document.getElementById('cfgTrustText').value;

      // Apply to page
      document.getElementById('schoolHeader').style.background = color;
      document.getElementById('schoolLogo').textContent = logo;
      document.getElementById('schoolName').textContent = schoolName;
      document.getElementById('schoolTagline').textContent = tagline;
      document.getElementById('productImage').textContent = productEmoji;
      document.getElementById('checkoutHeader').textContent = headerText;
      document.getElementById('checkoutSubtext').textContent = subtext;
      document.getElementById('trustText').innerHTML = '<strong>' + trustText.split('.')[0] + '</strong>';
      document.title = schoolName + ' - Checkout';
    }

    async function applyBranding() {
      applyBrandingOnly();

      const checkoutDiv = document.getElementById('checkout');
      checkoutDiv.innerHTML = '<div class="loading">Loading checkout...</div>';

      await stripeReady;
      if (!stripe) {
        checkoutDiv.innerHTML = '<div class="error"><strong>Error:</strong> Failed to load Stripe. Check API keys.</div>';
        return;
      }

      const mode = document.getElementById('cfgMode').value;
      const price = parseInt(document.getElementById('cfgPrice').value) || 2000;
      const productName = document.getElementById('cfgProductName').value;

      const lineItem = {
        price_data: {
          currency: 'usd',
          product_data: { name: productName },
          unit_amount: price,
        },
        quantity: 1,
      };
      if (mode === 'subscription') {
        lineItem.price_data.recurring = { interval: 'year' };
      }

      try {
        const res = await fetch('/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: mode,
            lineItems: [lineItem],
            automaticTax: true,
            ...(mode === 'payment' && { customerCreation: 'always' }),
          }),
        });
        const data = await res.json();
        if (data.error) {
          checkoutDiv.innerHTML = '<div class="error"><strong>Error:</strong> ' + data.error + '</div>';
          return;
        }
        if (checkout) checkout.destroy();
        checkout = await stripe.initEmbeddedCheckout({ clientSecret: data.clientSecret });
        checkoutDiv.innerHTML = '';
        checkout.mount('#checkout');
      } catch (error) {
        checkoutDiv.innerHTML = '<div class="error"><strong>Error:</strong> ' + error.message + '</div>';
      }
    }

    // Auto-apply branding on load
    applyBrandingOnly();
  </script>
</body>
</html>
